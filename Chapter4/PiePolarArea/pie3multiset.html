<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.min.js">
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/4.6.0/papaparse.min.js"></script>
</head>
<body>

<canvas id="my-pie-chart" width="400" height="200"></canvas>

<script>

    let numberOfEntries = 6;

    fetch('../Data/WPP2017_UN.csv')
        .then(response => response.text())
        .then((csv) => {
            let data = Papa.parse(csv, {header: true}).data;
            let reduced = reduceData(data, 10);
            drawData(reduced);
    });

    function reduceData(array) {
        array.sort((a, b) =>  a["2015"] - b["2015"]); // sort by 2015 data
        let topEntries =
            array.slice(array.length - numberOfEntries,array.length)
                 .map(d => { return {country: d["Country or region"], data2015: +d["2015"], data1960: +d["1980"]}; });
        let others = array.slice(0, array.length - numberOfEntries);
        let sum2015 = others.map(d => +d["2015"]).reduce((a,b) => a+b, 0);
        let sum1960 = others.map(d => +d["1980"]).reduce((a,b) => a+b, 0);
        others = {country: "Others", data2015: sum2015, data1960: sum1960};
        topEntries.push(others);
        return topEntries;
    }

    function drawData(data) {
        let dataset2015 = [];
        let dataset1980 = [];
        let labels = [];
        let colors2015 = [];
        let colors1980 = [];
        let count = 0;
        data.forEach(d => {
            dataset2015.push(d.data2015);
            dataset1980.push(d.data1960);
            labels.push(d.country);
            count++;
            colors2015.push('hsla('+(count * 300 / numberOfEntries)+', 100%, 50%, .9)');
            colors1980.push('hsla('+(count * 300 / numberOfEntries)+', 100%, 75%, .9)'); // lighter colors
        });

        console.log(""+dataset2015)
        console.log(""+dataset1980)

        let dataObj = {
            labels: labels,
            datasets: [
                {
                    data: dataset2015,
                    backgroundColor: colors2015,
                    borderWidth: 10,
                    hoverBackgroundColor: 'black',
                    hoverBorderColor: 'white'
                },
                {
                    data: dataset1980,
                    backgroundColor: colors1980,
                    borderWidth: 10,
                    hoverBackgroundColor: 'black',
                    hoverBorderColor: 'white'
                }
            ]
        }

        let chartObj = {
            type: "doughnut",
            data: dataObj,
            options: {
                legend: {
                    position: 'bottom'
                },
                tooltips: {
                    callbacks: {
                        label: function (tooltipItem, data) {
                            let value = data.datasets[tooltipItem.datasetIndex].data[tooltipItem.index];
                            var label = data.labels[tooltipItem.index] || '';
                            if (label) {
                                label += ': ';
                            }
                            label += Math.round(value/1000) + " million";
                            return label;
                        }
                    }
                }
            }
        };
        new Chart("my-pie-chart", chartObj);
    }


</script>

</body>
</html>