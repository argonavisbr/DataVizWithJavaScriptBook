<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.min.js">
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/4.6.0/papaparse.min.js"></script>
</head>
<body>

<canvas id="my-bar-chart" width="400" height="200"></canvas>

<script>

    let numberOfEntries = 20;

    fetch('../Data/cities15000.csv')
            .then(response => response.text())
    .then((csv) => {
        let data = Papa.parse(csv, {header: true}).data;
        let reduced = reduceData(data, 10);
        drawData(reduced);
    });

    function getColor(count) {
        return 'hsla('+(count * 300 / numberOfEntries)+', 100%, 70%, .9)';
    }

    function reduceData(array) {
        array.sort((a, b) =>  a.population - b.population);
        let top = array.slice(array.length - numberOfEntries,array.length)
                .map(d => {
                    return {city: d["asciiname"], data: +d.population};
                 });
        //let others = array.slice(0, array.length - numberOfEntries);
        //let sumOthers = others.map(d => +d.population).reduce((a,b) => a+b, 0);
        //others = {city: "Others", data: sumOthers};
        //top.push(others);
        return top;
    }

    function drawData(data) {
        let dataset = [];
        let labels = [];
        let colors = [];
        let count = 0;
        data.forEach(d => {
            dataset.push(d.data);
            labels.push(d.city);
            colors.push(getColor(count++));
        });

        let dataObj = {
            labels: labels,
            datasets: [
                {
                    data: dataset,
                    backgroundColor: colors,
                    borderWidth: 1,
                    hoverBackgroundColor: 'black',
                    hoverBorderColor: 'white'
                }
            ]
        }

        let chartObj = {
            type: "horizontalBar",
            data: dataObj,
            options: {
                legend: {
                    display: false
                },
                scales: {
                    xAxes: [{
                        ticks: {
                            min: 0
                        }
                    }]
                },
                tooltips: {
                    callbacks: {
                        label: function (tooltipItem, data) {
                            let value = data.datasets[0].data[tooltipItem.index];
                            var label = data.labels[tooltipItem.index] || '';
                            if (label) {
                                label += ': ';
                            }
                            label += Math.round(value/1000) + " million";
                            return label;
                        }
                    }
                }
            }
        };
        new Chart("my-bar-chart", chartObj);

    }


</script>

</body>
</html>