<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.min.js">
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/4.6.0/papaparse.min.js"></script>

</head>
<body>
<!-- https://data.worldbank.org/indicator/EN.ATM.CO2E.PC -->
<canvas id="my-area-chart" width="400" height="200"></canvas>

<script>
    let numberOfDatasets = 6;

    fetch('../Data/WorldBankCO2kt.csv')
            .then(response => response.text())
            .then((csv) => {
        let parsed = parseCO2CSV(csv);
    console.log(JSON.stringify(parsed));
        draw(parsed);
    });

    function parseCO2CSV(data) {
        let array = [];
        let rows = data.split("\n");
        let years = rows.shift().split("\",\"").slice(4,59);
        years = years.map(n => +n);
        rows.forEach(r => {
            let item = r.split("\",\"");
            let entry = {
                country: item[0].substring(1),
                data: item.slice(4,59).map(n => +n)
            };
            array.push(entry);
        });
        array.sort((a, b) =>  a.data.reduce((x, y) => x + y) - b.data.reduce((x, y) => x + y));
        let topTen = array.slice(array.length - numberOfDatasets,array.length);
        let others = array.slice(0, array.length - numberOfDatasets);
        others = others.reduce((a, b) => {
            return {country: "Others", data: a.data.map((val, i) => val + b.data[i])};
        });
        topTen.unshift(others);
        return {labels: years, entries: topTen};
    }

    function getColor(seed) {
        return 'hsla('+(seed*2)+',75%,75%,1)';
    }

//
    function draw(datasetsObj) {
        let datasets = [];
        let labels = [];
        datasetsObj.entries.forEach((entry, index) => {
            let color = getColor((index+5)*25);
            let dataset = {
                label: entry.country,
                data: entry.data,
                borderColor: color,
                backgroundColor: color,
                borderWidth: 3,
                fill: 'start',
                pointRadius: 0
            };
            datasets.push(dataset);
        });

        let dataObj = {
            labels: datasetsObj.labels,
            datasets: datasets
        }

        //Chart.defaults.global.elements.line.fill = false;

        let chartObj = {
            type: "line",
            data: dataObj,
            options:{
                scales: {
                    xAxes: [{
                        stacked: true
                    }],
                    yAxes: [{
                        stacked: true
                    }]
                },
                elements: {
                    line: {
                       fill: false
                    }
                },
                legend: {
                    lineWidth: 5,
                    labels: {
                        boxWidth: 20,
                    }
                }

            }
        };
        console.log(chartObj)
        new Chart("my-area-chart", chartObj);
    }
</script>


</body>
</html>