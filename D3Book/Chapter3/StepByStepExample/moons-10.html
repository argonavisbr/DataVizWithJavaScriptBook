<!DOCTYPE html>
<html lang="en">
<head>
    <title>Moons</title>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <style>
        svg { border: solid 1px gray; }
        * { font-family: 'Yanone Kaffeesatz', sans-serif; }
        text { font-size: 11px; }
    </style>
</head>
<body>

<h1>The largest moons of <span id="planet"></span></h1>
<div id="container" width="500" height="300">
    <svg height="100%" width="100%" id="moons"></svg>
</div>
<form></form>

<script>

    // global variables and constants

    let planets;          // will contain the data used in the application
    let moons;            // will contain the moons to be displayed
    let currentId = 'p5'; // key to select current object (p5 = Jupiter)
    let currentPlanet;    // the object used in the current view

    // a function that will scale the diameters in km to pixels
    const scale = d3.scaleLinear();

    // dimensions and spacing for the SVG graphics context
    const WIDTH = 500, HEIGHT = 300;
    const MARGIN_W = 20, MARGIN_H = 50;
    const MARGIN_MOON = 10;    // space between moons
    const MARGIN_PLANET = 100; // space that will be reserved for the planet

    // colors for planets
    const planetColors = ['#4169e1', '#cc8530', '#d4a450', '#dab520', '7fffd4', '1e90ff'];

    // obtains a handle to the SVG element and sets up the view port
    const svg = d3.select("#moons")
            .attr("viewBox", "0 0 " + WIDTH + " " + HEIGHT);
    // create SVG group with coordinates in the middle of the view
    const plane = svg.append("g")
            .attr("transform", "translate("+[MARGIN_PLANET, HEIGHT/2]+")");

    d3.json("../Data/sol_2016.json")
        .then(function(data) {
            planets = data.planets.filter(p => +p.id.substring(1) >= 3
                    && +p.id.substring(1) <= 8);
            init();
            configView();
            draw();
        });

    function init() {
        d3.select("form")
            .selectAll("button")
            .data(planets)
            .enter()
            .append("button")
            .attr("type", "button") // disables default submission
            .attr("id", function(d) {
                return d.id;
            })
            .text(function(d) {
                return d.name;
            })
            .on("click", function(d) {
                currentId = d.id;
                configView();
                draw();
            });

        plane.append("circle")
             .attr("class", "planet")
             .datum(currentPlanet);
    }

    function draw() {
        d3.select('#planet').text(() => currentPlanet.name);

        // update planet
        plane.select(".planet")
            .datum(currentPlanet)
            .attr("r", function(d) {
                return scale(d.diameterKm)/2;
            })
            .attr("cx", function(d, i) {
                return -(MARGIN_W + scale(d.diameterKm)/2);
            })
            .style("fill", d => planetColors[(+currentId.substring(1) - 3)]);

        // the update selection
        const updateMoons = plane.selectAll(".moon") // selects elements of class ‘moon’
            .data(moons);                            // joins elements with data

        // the enter selection - could be empty
        const enterMoons = updateMoons
                .enter()
                .append("g").attr("class", "moon")
                .each(function() {
                    const moon = d3.select(this);
                    moon.append("circle");
                    moon.append("text")
                });

        // the merged selection
        enterMoons.merge(updateMoons)
            .attr("transform", function(d) {  // updates position of each moon
                return "translate("+[d.cx,0]+")";
            })
            .each(function() {
                const moon = d3.select(this);
                moon.select("circle")
                    .attr("r", function(d) {           // updates the radius
                        return scale(d.diameterKm)/2;
                    });
                moon.select("text")                    // updates the name
                    .text(function(d) {
                        return d.name;
                    })
                    .attr("transform", function(d) {   // updates text position
                        const x = scale(d.diameterKm/2) + MARGIN_MOON;
                        const y = this.getBBox().height/4;
                        return ("rotate(-90) translate("+[x,y]+")");
                    });
            });

    }

    function configView() {   // this function will set up the scales

        d3.selectAll("button").property("disabled", false);
        d3.select("#"+currentId).property("disabled", true);

        // get the current object filtering by its id
        currentPlanet = planets.filter(p => p.id == currentId)[0];

        // obtains the diameter of the largest moon
        let maxDiameter = d3.max(currentPlanet.satellites, function(d) {
            return d.diameterKm;
        });

        // includes only moons with 1/50 of the size of the largest moon or larger
        moons = currentPlanet.satellites.filter(s => s.diameterKm > maxDiameter/50);

        // adds diameters (they will be drawn side by side)
        let sumDiametersKm = d3.sum(moons, function(d) {
            return d.diameterKm;
        });

        // calculates the space occupied by the circles
        let horizSpace = WIDTH - (MARGIN_PLANET + MARGIN_W*2 + moons.length * MARGIN_MOON);
        let vertSpace  = HEIGHT - MARGIN_H*2;

        // configures the scale
        scale.range([0, d3.min([vertSpace, horizSpace])])
             .domain([0, sumDiametersKm]);

        // Uncomment to sort the moons by diameter
        moons.sort((a,b) => d3.descending(a.diameterKm, b.diameterKm));

        // calculates cx coordinates for moons
        moons.forEach(function(current, i) {
            let space = 0;
            if(i > 0) {
                let previous = moons[i-1]
                space = previous.cx
                        + scale(previous.diameterKm)/2
                        + MARGIN_MOON;
            }
            current.cx = space + scale(current.diameterKm)/2;
        });
    }

</script>


</body>
</html>
