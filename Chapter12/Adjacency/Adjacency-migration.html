<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="../JavaScript/simple_graph_data.js"></script>
</head>
<body>

<script>
    // load file with countries and populations
    // calculate percentage
    // filter file and keep only 25 largest
    const width = 6000;
    const height = 6000;

    d3.csv("../Data/migration_2017.csv", function(d) {
        delete d.Total_Emigrants;
        var row = {};
        Object.keys(d).forEach(function(key) {
            if(key != 'Destination') {
                row[key] = +d[key];
            } else {
                row[key] = d[key];
            }
        })
        return row;
    }).then(function(data) {

        if(Object.keys(data[0]).length - 1 != data.length) {
            throw `Not square matrix: Cols: ${Object.keys(data[0]).length}} != Rows: ${data.length}`;
        }

        const countriesScale = d3.scaleLinear()
                .range([0,width])
                .domain([0,data.length]);
        const populationScale = d3.scaleLinear()
                .range(['white', 'red'])
                .domain([0,d3.max(data, d => d3.max(Object.values(d).filter(v => !isNaN(v))))]);
        const side = width / data.length;

        console.log()
        console.log(populationScale('aa'))
        console.log(populationScale(''))
        console.log(populationScale(100))
        console.log(populationScale(100000))
        console.log(populationScale(1000000))
        console.log(populationScale(12000000))

        const svg = d3.select("body").append("svg").attr("width", width).attr("height", height);

        const chart = svg.append("g").attr("class", "chart");

        chart.selectAll("g.row")
                .data(data)
                .enter()
                .append("g")
                .attr("class","row")
                .each(function(d,i) {
                    d3.select(this)
                        .selectAll("rect")
                        .data(d => Object.keys(d).filter(k => k != 'Destination'))
                        .enter()
                        .append("rect")
                        .attr("x", (e,j) => countriesScale(j))
                        .attr("y", countriesScale(i))
                        .attr("height", side)
                        .attr("width", side)
                            .attr("stroke", "gray")
                            .attr("fill", e => populationScale(d[e]));

                }).append("text")
                .attr("x", 10)
                .attr("y", (d,i) => countriesScale(i) + 12)
                .attr("font-size", 10)
                .attr("fill", "black")
                .text(d => d.Destination);

        d3.select("g.row:last-child").selectAll("text")
                .data(data.columns.filter(d => d != 'Total_Emigrants'))
                .enter()
                .append("text")
                .attr("x", (e,j) => countriesScale(j))
                .attr("y", 0)
                .attr("font-size", 10)
                .attr("text-anchor", 'end')
                .attr("transform", (e,j) => `rotate(-90,${countriesScale(j)},6)`)
                .attr("fill", "black")
                .text(e => e);
    });
</script>

</body>
</html>