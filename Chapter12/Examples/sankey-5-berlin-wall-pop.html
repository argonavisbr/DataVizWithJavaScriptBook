<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://unpkg.com/d3-sankey"></script>
    <style>
        text {
            font-family: 'Yanone Kaffeesatz', sans-serif;
            font-size: 10px;
            alignment-baseline: middle;
            text-anchor: middle;
            fill: black;
            pointer-events: none;
        }
        .faded {
            opacity: .2;
        }
    </style>
</head>
<body>
<script>
    const width = 1000;
    const height = 1000;
    const margin = 100;

    const color = d3.scaleOrdinal(d3.schemeCategory10);

    const links = [];

    d3.csv("../Data/EuropeUSSR_1990_2010_nodes.csv", function(row) {
        if(+row.State == 1) {
            if (row.Containers.length > 0 && row.Id != 'WB') {
                const groups = row.Containers.split('|');
                groups.forEach(function (group) {
                    if(group.length != 4 && group != 'WSP' && group != 'EEC') {
                        const link = {}
                        if (group == 'DEU') { // join
                            link.target = group;
                            link.source = row.Id;
                        } else { // split
                            link.target = row.Id;
                            link.source = group;
                        }
                        link.value = Math.sqrt(+row.Area);
                        links.push(link);
                    }
                });
            } else if (+row.Unit == 1) {
                return undefined;
            }
            row.Area = +row.Area;
            return row;
        }
    }).then(function(rows) {
        const linked = d3.merge([links.map(k => k.source),links.map(k => k.target)]);
        nodes = rows.filter(n => +n.State == 1 && linked.indexOf(n.Id) >= 0);

        links.forEach(function(link) {
            link.source = nodes.map(n => n.Id).indexOf(link.source);
            link.target = nodes.map(n => n.Id).indexOf(link.target);
        });

        color.domain([0, nodes.length]);

        const sankey = d3.sankey()
                .nodePadding(10)
                .nodeWidth(110)
                .extent([[margin/2, margin/2], [width-margin, height-margin]])
                .nodeAlign(d3.sankeyJustify)
                .iterations(500);

        const graph = sankey({nodes: nodes, links: links});
        console.log(graph);

        const svg = d3.select("body").append("svg").attr("width",width).attr("height",height);

        draw(graph, svg);

        drawFade(svg);
    });

    function drawFade(svg) {
        for(let i = 0; i < 30; i++) {
            svg.append('rect')
                    .attr('y', margin/2 + i*i/15)
                    .attr("width", width)
                    .attr("height", (1 - i/30) * 8)
                    .attr("fill", 'white');
        }

    }

    function draw(graph, svg) {
        const chart = svg.append("g");

        chart.selectAll('path')
                .data(graph.links)
                .enter()
                .append('path')
                .attr('d', d3.sankeyLinkHorizontal())
                .attr("stroke-opacity", .4)
                .attr('stroke-width', d => d.width)
                .attr('stroke', d => d.target.Id == 'DEU' ? color(d.source.index) : color(d.target.index))
                .attr('fill', 'none')
                .on('mouseover', highlightPath)
                .on('mouseout', d => d3.selectAll("rect, path, text").classed('faded', false));

        chart.selectAll('rect')
            .data(graph.nodes)
            .enter()
            .append('rect')
            .attr('x', d => d.x0)
            .attr('y', function(d) {
                    if(d.y1 - d.y0 < 12) {
                        return d.y0 +(d.y1 - d.y0)/2 - 5;
                    }
                    return d.y0;
                })
            .attr('width', d => d.x1 - d.x0)
            .attr('height', function(d) {
                if(d.y1 - d.y0 < 12) {
                    return 10;
                }
                return d.y1 - d.y0;
            })
            .attr('rx', d => d.y1 - d.y0 < 4?10:0).attr('ry', d => d.y1 - d.y0 < 4?5:0)
            .attr('fill', (d,i) => d3.rgb(color(i)).darker(.5))
            .style('fill-opacity', .8)
            .on('mouseover', highlightNode)
            .on('mouseout', d => d3.selectAll("rect, path, text").classed('faded', false));

        chart.selectAll('text')
            .data(graph.nodes)
            .enter()
            .append('text')
            .attr('x', d => (d.x1 + d.x0)/2)
            .attr('y', d => (d.y1 + d.y0)/2 + 1)
            .text(d => d.Country)
            .style("fill", (d,i) => contrast(d3.rgb(color(i)).darker(.5)))
            .style('text-anchor', 'middle')
            .style('font-size', function(d) {
                    if(d.y1 - d.y0 < 15) {
                        return 10;
                    }
                    return 16;
                });
            }

    function contrast(color) {
        const c = d3.rgb(color);
        return (c.r * 0.299 + c.g * 0.587 + c.b * 0.114) > 130 ? 'black' : 'white';
    }

    function highlightNode(node) {
        console.log(node)
        d3.selectAll("rect, text").classed('faded', d => !(d === node));
        d3.selectAll("path").classed('faded', edge => !(edge.source === node || edge.target == node));
    }
    function highlightPath(edge) {
        console.log(edge)
        d3.selectAll("rect, text").classed('faded', node => !(node === edge.source || node === edge.target))
        d3.selectAll("path").classed('faded', d => !(d === edge));
    }
</script>

</body>
</html>