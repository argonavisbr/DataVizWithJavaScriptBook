<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <style>
        svg {
            border: solid 1px gray;
        }
        * {
            font-family: 'Yanone Kaffeesatz', 'Arial Narrow', sans-serif;
        }
        text {
            font-size: 11px;
        }
        .tooltip {
            opacity: 0;
        }
        .tooltip rect {
            fill: rgba(255,255,255,.8);
            stroke: gray;
            stroke-width: 2px;
            height: 30px;
            width: 100px;
            rx: 5px;
            ry: 5px;
            pointer-events: none;
        }
        .tooltip text {
            transform: translate(18px,18px);
        }
    </style>
</head>
<body>
<h1>The <span id="fraction">largest</span> moon<span id="amount"></span> of <span id="planet"></span></h1>
<div id="container" width="500" height="300">
    <svg height="100%" width="100%" id="moons"></svg>
</div>
<form>
</form>
<script>
    const div = d3.select("#container");
    const   width = 500,
            height = 300;
    const spacingLarge = 10, spacingSmall = 2, marginW = 20, marginH = 50;

    const marginPlanet = 100;
    let maxDiameter, minDiameter, totalSatellites;
    let planets, currentPlanet;
    let largeSatellites = [], smallSatellites = [];
    let planetColors = ['blue', '#a60', '#eb3', '#a71', 'aqua', 'dodgerblue'];

    const scale = d3.scaleLinear();
    const colorScale = d3.scaleSequential(d3.interpolateInferno);

    const svg = d3.select("#moons")
            .attr("viewBox", "0 0 " + width + " " + height);
    const group = svg.append("g")
            .attr("transform", "translate("+[marginPlanet,height/2]+")");

    const tooltip = svg.append("g")
            .attr("transform", "translate("+[marginPlanet,height/2]+")")
            .append("g")
            .attr("class", "tooltip");
    tooltip.append("rect");
    tooltip.append("text");


    d3.json("../Data/sol_2016.json").then(function(data) {
        planets = data.planets.filter(p => +p.id.substring(1) >= 3 && +p.id.substring(1) <= 8);
        configPanel();
        configPage("p3");
        draw();
    });

    function configPanel() {
        planets.forEach(function (planet) {
            d3.select("form")
                    .append("button")
                    .attr("type", "button")
                    .attr("id", () => planet.id)
                    .text(() => planet.name)
                    .on("click", function () {
                        configPage(planet.id);
                        redraw();
                    });
        });
    }

    function configPage(id) {
        currentPlanet = planets.filter(p => p.id == id)[0];
        d3.select('#planet').text(d => currentPlanet.name);
        d3.select('#amount').text(function(d) {
            return currentPlanet.satellites.length != 1 ? 's' : '';
        });
        d3.selectAll("button").property("disabled", false);
        d3.select("#"+id).property("disabled", true);

        [minDiameter, maxDiameter] = d3.extent(currentPlanet.satellites, function(d) {
            return d.diameterKm;
        });

        largeSatellites = currentPlanet.satellites.filter(s => s.diameterKm > maxDiameter/50);
        largeSatellites.sort((a,b)=>d3.descending(a.diameterKm,b.diameterKm));
        let largeSum = d3.sum(largeSatellites, function(d) {
            return d.diameterKm;
        });

        d3.select('#fraction').text(function(d) {
            return largeSatellites.length == currentPlanet.satellites.length ? "" : 'largest';
        });

        let horizSpace = width - (marginPlanet + marginW*2 + largeSatellites.length * 10);
        let vertSpace  = height - marginH*2;
        let satKmSpace = largeSum;

        scale.range([0, d3.min([vertSpace, horizSpace])]).domain([0, satKmSpace]);
        colorScale.domain([0, satKmSpace*1.5]);
    }

    function redraw() {
        group.select(".planet")
                .data([currentPlanet])
                .attr("r", function(d) {
                    return scale(d.diameterKm)/2;
                })
                .attr("cx", function(d, i) {
                    return -(marginW + scale(d.diameterKm)/2);
                }).style("fill", function(d) {
                    return planetColors[d.id.substring(1)-3];
                });

        // update
        let moons = group.selectAll(".moon").data(largeSatellites);
        let circles = moons.select("circle")
        let labels  = moons.select("text");

        // exit
        moons.exit().remove();

        // enter
        let newMoons = moons.enter()
                .append("g").attr("class", "moon")
                .attr("id", function(d,i) {
                    return "moon_" + i;
                });

        newMoons.append("circle")
                .style("fill", function(d,i) {
                    return colorScale(d.diameterKm);
                })
                .merge(circles)
                .attr("r", function(d,i) {
                    return scale(d.diameterKm)/2;
                })
                .attr("cx", function(d, i) {
                    return positionCenter(d,i);
                });

        newMoons.append("text")
                .merge(labels)
                .text(function(d) {
                    return d.name;
                })
                .attr("transform", function(d,i) {
                    return positionLabel(this, d,i);
                });

        newMoons.on("mouseover", function(d,i) {
                    d3.select(".tooltip")
                    .attr("transform", function() {
                        return "translate("+positionCenter(d,i)+","+scale(d.diameterKm/4)+")";
                    })
                    .style("opacity", 1)
                    .select("text")
                    .text(function() {
                        return "Diameter: " + d.diameterKm + " km";
                    });
                })
                .on("mouseout", function(d,i) {
                    d3.select(".tooltip")
                            .style("opacity", 0);
                });
    }

    function draw() {
        let planet = group.selectAll(".planet")
                .data([currentPlanet])
                .enter()
                .append("circle").attr("class", "planet")
                .attr("r", function(d) {
                    return scale(d.diameterKm)/2;
                })
                .attr("cx", function(d, i) {
                    return -(marginW + scale(d.diameterKm)/2);
                })
                .style("fill", function(d) {
                    return planetColors[d.id.substring(1)-3];
                });

        let moon = group.selectAll(".moon")
                .data(largeSatellites)
                .enter()
                .append("g").attr("class", "moon")
                .attr("id", function(d,i) {
                    return "moon_" + i;
                });

        moon.append("circle")
                .attr("r", function(d) {
                    return scale(d.diameterKm)/2;
                })
                .attr("cx", function(d, i) {
                    return positionCenter(d,i);
                })
                .style("fill", function(d,i) {
                    return colorScale(d.diameterKm);
                });

        moon.append("text")
                .text(function(d) {
                    return d.name;
                })
                .attr("transform", function(d,i) {
                    return positionLabel(this, d,i);
                });

        moon.on("mouseover", function(d,i) {
            d3.select(".tooltip")
                    .attr("transform", function() {
                        return "translate("+positionCenter(d,i)+","+scale(d.diameterKm/4)+")";
                    })
                    .style("opacity", 1)
                    .select("text")
                    .text(function() {
                        return "Diameter: " + d.diameterKm + " km";
                    });
        }).on("mouseout", function(d,i) {
            d3.select(".tooltip")
                    .style("opacity", 0);
        });

        planet.on("mouseover", function(d,i) {
            d3.select(".tooltip")
                    .attr("transform", function() {
                        return "translate(-75,50)";
                    })
                    .style("opacity", 1)
                    .select("text")
                    .text(function() {
                        return "Diameter: " + d.diameterKm + " km";
                    });
        }).on("mouseout", function(d,i) {
            d3.select(".tooltip")
                    .style("opacity", 0);
        });
    }

    function positionLabel(obj, d, i) {
        const x = scale(d.diameterKm)/2 + 10;
        const y = positionCenter(d,i) + obj.getBBox().height/4;
        return "rotate(-90, 0, 0) translate("+x+", "+y+")";
    }

    function positionCenter(d, i) {
        let spacing = 0;
        if(i > 0) {
            let previous = d3.select("#moon_"+(i-1) + " circle");
            spacing = +previous.attr("cx") + +previous.attr("r") + 10;
        }
        return spacing + scale(d.diameterKm)/2;
    }
</script>
</body>
</html>