<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <style>
        svg {
            border: solid 1px gray;
        }
        * {
            font-family: 'Yanone Kaffeesatz', 'Arial Narrow', sans-serif;
        }
        text {
            font-size: 11px;
        }
    </style>
</head>
<body>
<h1>The largest moons</h1>
<div id="container" width="500" height="300">
    <svg height="100%" width="100%" id="moons"></svg>
</div>
<form></form>
<script>
    const   width = 500,
            height = 300;
    const marginW = 20, marginH = 50;

    const marginPlanet = 100;
    let minDiameter, planets, currentPlanet;
    let largeSatellites = [];

    const scale = d3.scaleLinear();

    const svg = d3.select("#moons")
            .attr("viewBox", "0 0 " + width + " " + height);
    const group = svg.append("g")
            .attr("transform", "translate("+[marginPlanet,height/2]+")");

    d3.json("../Data/sol_2016.json").then(function(data) {
        planets = data.planets.filter(p => +p.id.substring(1) >= 3 && +p.id.substring(1) <= 8);
        configPage("p5");
        draw();
    });

    function configPage(id) {
        currentPlanet = planets.filter(p => p.id == id)[0];

        [minDiameter, maxDiameter] = d3.extent(currentPlanet.satellites, function(d) {
            return d.diameterKm;
        });

        largeSatellites = currentPlanet.satellites
                        .filter(s => s.diameterKm > maxDiameter/50);
        let largeSum = d3.sum(largeSatellites, function(d) {
            return d.diameterKm;
        });

        let space = width - (marginPlanet + marginW*2 + largeSatellites.length * 10);

        scale.range([0, space]).domain([0, largeSum]);
    }

    function draw() {
        let planet = group.selectAll(".planet")
                .data([currentPlanet])
                .enter()
                .append("circle").attr("class", "planet")
                .attr("r", function(d) {
                    return scale(d.diameterKm)/2;
                })
                .attr("cx", function(d, i) {
                    return -(marginW + scale(d.diameterKm)/2);
                });

        group.selectAll(".moon")
                .data(largeSatellites)
                .enter()
                .append("circle").attr("class", "moon")
                .attr("id", function(d,i) {
                    return "moon_" + i;
                })
                .attr("r", function(d) {
                    return scale(d.diameterKm)/2;
                })
                .attr("cx", function(d, i) {
                    let spacing = 0;
                    if(i > 0) {
                        let previous = d3.select("#moon_"+(i-1));
                        spacing = +previous.attr("cx") + +previous.attr("r") + 10;
                    }
                    return spacing + scale(d.diameterKm)/2;
                });
    }
</script>
</body>
</html>